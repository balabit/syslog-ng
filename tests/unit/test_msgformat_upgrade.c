/*
 * Copyright (c) 2002-2012 BalaBit IT Ltd, Budapest, Hungary
 * Copyright (c) 1998-2012 Bal√°zs Scheidler
 * Copyright (c) 2012-2013 Viktor Juhasz
 * Copyright (c) 2012-2013 Viktor Tusa
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 * As an additional exemption you are allowed to compile & link against the
 * OpenSSL libraries as published by the OpenSSL project. See the file
 * COPYING for details.
 *
 */

#include "syslog-ng.h"
#include "serialize.h"
#include "misc.h"
#include "logmsg.h"
#include "logmsg-serialize.h"
#include "nvtable-serialize.h"
#include "apphook.h"

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>

/* serialized message in syslog-ng 2.1 format, version ID 1 */
const guint8 msg_serialized_21[] =
{
  0x01, 0x00, 0xbe, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x02, 0x0a, 0x0a, 0x0a, 0x0a, 0xf2, 0x03, 0x46,
  0x22, 0x7c, 0xcd, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1c, 0x20, 0x48, 0x84, 0xe7, 0x94, 0x00,
  0x0a, 0x69, 0xa1, 0x00, 0x00, 0x1c, 0x20, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0d, 0x25, 0x50, 0x49, 0x58, 0x2d,
  0x36, 0x2d, 0x33, 0x30, 0x32, 0x30, 0x31, 0x34,
  0x00, 0x00, 0x00, 0x8a, 0x25, 0x50, 0x49, 0x58,
  0x2d, 0x36, 0x2d, 0x33, 0x30, 0x32, 0x30, 0x31,
  0x34, 0x3a, 0x20, 0x54, 0x65, 0x61, 0x72, 0x64,
  0x6f, 0x77, 0x6e, 0x20, 0x54, 0x43, 0x50, 0x20,
  0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69,
  0x6f, 0x6e, 0x20, 0x31, 0x36, 0x38, 0x38, 0x34,
  0x33, 0x38, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x62,
  0x6c, 0x6f, 0x6f, 0x6d, 0x62, 0x65, 0x72, 0x67,
  0x2d, 0x6e, 0x65, 0x74, 0x3a, 0x31, 0x2e, 0x32,
  0x2e, 0x33, 0x2e, 0x34, 0x2f, 0x38, 0x32, 0x39,
  0x34, 0x20, 0x74, 0x6f, 0x20, 0x69, 0x6e, 0x73,
  0x69, 0x64, 0x65, 0x3a, 0x35, 0x2e, 0x36, 0x2e,
  0x37, 0x2e, 0x38, 0x2f, 0x33, 0x36, 0x33, 0x39,
  0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f,
  0x6e, 0x20, 0x30, 0x3a, 0x30, 0x37, 0x3a, 0x30,
  0x31, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x20,
  0x31, 0x36, 0x39, 0x37, 0x35, 0x20, 0x54, 0x43,
  0x50, 0x20, 0x46, 0x49, 0x4e, 0x73, 0x00
};

/* syslog-ng 3.0.1, version ID 10 */
const guint8 msg_serialized_version10[] =
{
  0x0a, 0x00, 0x00, 0x00, 0xbe, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x02, 0x0a, 0x0a, 0x0a, 0x0a, 0xf2,
  0x03, 0x00, 0x00, 0x00, 0x00, 0x46, 0x22, 0x7c,
  0xcd, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c,
  0x20, 0x00, 0x00, 0x00, 0x00, 0x49, 0x65, 0xcc,
  0x7d, 0x00, 0x0b, 0x16, 0xb6, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x0d, 0x25, 0x50, 0x49,
  0x58, 0x2d, 0x36, 0x2d, 0x33, 0x30, 0x32, 0x30,
  0x31, 0x34, 0x00, 0x00, 0x00, 0x7b, 0x54, 0x65,
  0x61, 0x72, 0x64, 0x6f, 0x77, 0x6e, 0x20, 0x54,
  0x43, 0x50, 0x20, 0x63, 0x6f, 0x6e, 0x6e, 0x65,
  0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x31, 0x36,
  0x38, 0x38, 0x34, 0x33, 0x38, 0x20, 0x66, 0x6f,
  0x72, 0x20, 0x62, 0x6c, 0x6f, 0x6f, 0x6d, 0x62,
  0x65, 0x72, 0x67, 0x2d, 0x6e, 0x65, 0x74, 0x3a,
  0x31, 0x2e, 0x32, 0x2e, 0x33, 0x2e, 0x34, 0x2f,
  0x38, 0x32, 0x39, 0x34, 0x20, 0x74, 0x6f, 0x20,
  0x69, 0x6e, 0x73, 0x69, 0x64, 0x65, 0x3a, 0x35,
  0x2e, 0x36, 0x2e, 0x37, 0x2e, 0x38, 0x2f, 0x33,
  0x36, 0x33, 0x39, 0x20, 0x64, 0x75, 0x72, 0x61,
  0x74, 0x69, 0x6f, 0x6e, 0x20, 0x30, 0x3a, 0x30,
  0x37, 0x3a, 0x30, 0x31, 0x20, 0x62, 0x79, 0x74,
  0x65, 0x73, 0x20, 0x31, 0x36, 0x39, 0x37, 0x35,
  0x20, 0x54, 0x43, 0x50, 0x20, 0x46, 0x49, 0x4e,
  0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x03, 0x54,
  0x65, 0x61, 0x00, 0x00, 0x00, 0x00, 0x01, 0x54,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x61, 0x00, 0x00, 0x00, 0x00,
  0x08, 0x68, 0x65, 0x68, 0x65, 0x68, 0x65, 0x68,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
};

const guint8 msg_serialized_version11[331] = {
  0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x0a, 0x0a, 0x0a,
  0x0a, 0xf2, 0x03, 0x00, 0x00, 0x00, 0x00, 0x46,
  0x22, 0x7c, 0xcd, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1c, 0x20, 0x00, 0x00, 0x00, 0x00, 0x49,
  0x65, 0xcc, 0x7d, 0x00, 0x0b, 0x16, 0xb6, 0x00,
  0x00, 0x0e, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x25,
  0x50, 0x49, 0x58, 0x2d, 0x36, 0x2d, 0x33, 0x30,
  0x32, 0x30, 0x31, 0x34, 0x00, 0x00, 0x00, 0x7b,
  0x54, 0x65, 0x61, 0x72, 0x64, 0x6f, 0x77, 0x6e,
  0x20, 0x54, 0x43, 0x50, 0x20, 0x63, 0x6f, 0x6e,
  0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20,
  0x31, 0x36, 0x38, 0x38, 0x34, 0x33, 0x38, 0x20,
  0x66, 0x6f, 0x72, 0x20, 0x62, 0x6c, 0x6f, 0x6f,
  0x6d, 0x62, 0x65, 0x72, 0x67, 0x2d, 0x6e, 0x65,
  0x74, 0x3a, 0x31, 0x2e, 0x32, 0x2e, 0x33, 0x2e,
  0x34, 0x2f, 0x38, 0x32, 0x39, 0x34, 0x20, 0x74,
  0x6f, 0x20, 0x69, 0x6e, 0x73, 0x69, 0x64, 0x65,
  0x3a, 0x35, 0x2e, 0x36, 0x2e, 0x37, 0x2e, 0x38,
  0x2f, 0x33, 0x36, 0x33, 0x39, 0x20, 0x64, 0x75,
  0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x30,
  0x3a, 0x30, 0x37, 0x3a, 0x30, 0x31, 0x20, 0x62,
  0x79, 0x74, 0x65, 0x73, 0x20, 0x31, 0x36, 0x39,
  0x37, 0x35, 0x20, 0x54, 0x43, 0x50, 0x20, 0x46,
  0x49, 0x4e, 0x73, 0x00, 0x00, 0x00, 0x0b, 0x50,
  0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49,
  0x44, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x4d, 0x65,
  0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x49, 0x44,
  0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x03, 0x54,
  0x65, 0x61, 0x00, 0x00, 0x00, 0x00, 0x01, 0x54,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x61, 0x00, 0x00, 0x00, 0x00,
  0x08, 0x68, 0x65, 0x68, 0x65, 0x68, 0x65, 0x68,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x07, 0x45, 0x6c, 0x65,
  0x6d, 0x65, 0x6e, 0x74, 0x00, 0x00, 0x00, 0x09,
  0x50, 0x61, 0x72, 0x61, 0x6d, 0x4e, 0x61, 0x6d,
  0x65, 0x00, 0x00, 0x00, 0x0a, 0x50, 0x61, 0x72,
  0x61, 0x6d, 0x56, 0x61, 0x6c, 0x75, 0x65, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00,
};

const guint8 msg_serialized_version23[493] = {
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x00,
  0x02, 0x0a, 0x0a, 0x0a, 0x0a, 0xf2, 0x03, 0x00,
  0x00, 0x00, 0x00, 0x46, 0x22, 0x7c, 0xcd, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x20, 0x00,
  0x00, 0x00, 0x00, 0x49, 0x65, 0xcc, 0x7d, 0x00,
  0x0b, 0x16, 0xb6, 0x00, 0x00, 0x0e, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x05, 0x01, 0x08, 0x01,
  0x76, 0x32, 0x54, 0x56, 0x4e, 0x00, 0x00, 0xb0,
  0x00, 0x5e, 0x00, 0x06, 0x08, 0x00, 0x07, 0x00,
  0x0c, 0x00, 0x36, 0x00, 0x13, 0x00, 0x3c, 0x00,
  0x42, 0x00, 0x04, 0x00, 0x00, 0x00, 0x76, 0x00,
  0x45, 0x00, 0x77, 0x00, 0x48, 0x00, 0x78, 0x00,
  0x4b, 0x00, 0x79, 0x00, 0x4e, 0x00, 0x7a, 0x00,
  0x53, 0x01, 0x76, 0x00, 0x5e, 0x00, 0x18, 0x0b,
  0x00, 0x0a, 0x00, 0x2e, 0x53, 0x44, 0x41, 0x54,
  0x41, 0x2e, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e,
  0x74, 0x2e, 0x50, 0x61, 0x72, 0x61, 0x6d, 0x4e,
  0x61, 0x6d, 0x65, 0x00, 0x50, 0x61, 0x72, 0x61,
  0x6d, 0x56, 0x61, 0x6c, 0x75, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x05, 0x00, 0x08, 0x00, 0x34,
  0x00, 0x68, 0x65, 0x68, 0x65, 0x68, 0x65, 0x68,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
  0x00, 0x01, 0x00, 0x33, 0x00, 0x61, 0x00, 0xed,
  0x00, 0x00, 0x01, 0x03, 0x00, 0x01, 0x00, 0x32,
  0x00, 0x65, 0x00, 0x00, 0x00, 0xa0, 0x01, 0x03,
  0x00, 0x01, 0x00, 0x31, 0x00, 0x54, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x03, 0x00, 0x03, 0x00, 0x30,
  0x00, 0x54, 0x65, 0x61, 0x00, 0x20, 0x00, 0x06,
  0x00, 0x0b, 0x00, 0x00, 0x4d, 0x65, 0x73, 0x73,
  0x61, 0x67, 0x65, 0x20, 0x49, 0x44, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x06,
  0x00, 0x0b, 0x00, 0x00, 0x50, 0x72, 0x6f, 0x63,
  0x65, 0x73, 0x73, 0x20, 0x49, 0x44, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x23,
  0x00, 0x7b, 0x00, 0x00, 0x54, 0x65, 0x61, 0x72,
  0x64, 0x6f, 0x77, 0x6e, 0x20, 0x54, 0x43, 0x50,
  0x20, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74,
  0x69, 0x6f, 0x6e, 0x20, 0x31, 0x36, 0x38, 0x38,
  0x34, 0x33, 0x38, 0x20, 0x66, 0x6f, 0x72, 0x20,
  0x62, 0x6c, 0x6f, 0x6f, 0x6d, 0x62, 0x65, 0x72,
  0x67, 0x2d, 0x6e, 0x65, 0x74, 0x3a, 0x31, 0x2e,
  0x32, 0x2e, 0x33, 0x2e, 0x34, 0x2f, 0x38, 0x32,
  0x39, 0x34, 0x20, 0x74, 0x6f, 0x20, 0x69, 0x6e,
  0x73, 0x69, 0x64, 0x65, 0x3a, 0x35, 0x2e, 0x36,
  0x2e, 0x37, 0x2e, 0x38, 0x2f, 0x33, 0x36, 0x33,
  0x39, 0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69,
  0x6f, 0x6e, 0x20, 0x30, 0x3a, 0x30, 0x37, 0x3a,
  0x30, 0x31, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73,
  0x20, 0x31, 0x36, 0x39, 0x37, 0x35, 0x20, 0x54,
  0x43, 0x50, 0x20, 0x46, 0x49, 0x4e, 0x73, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x07, 0x00, 0x0d, 0x00, 0x00,
  0x25, 0x50, 0x49, 0x58, 0x2d, 0x36, 0x2d, 0x33,
  0x30, 0x32, 0x30, 0x31, 0x34, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_single_message_v20[109] = {
  0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x94, 0xb7,
  0xf1, 0x00, 0x02, 0xc0, 0x08, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x1c, 0x58, 0x00, 0x06,
  0x00, 0x00, 0x00, 0x08, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x06,
  0x00, 0x06, 0x00, 0x00, 0x61, 0x6c, 0x6d, 0x61,
  0x66, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_single_message_and_dynamic_v20[133] = {
  0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x94, 0xb7,
  0xf1, 0x00, 0x02, 0xc0, 0x08, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x20, 0x58, 0x00, 0x0b,
  0x00, 0x01, 0x00, 0x08, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x60,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x2c, 0x00, 0x04, 0x05, 0x00, 0x05, 0x00, 0x61,
  0x6c, 0x6d, 0x61, 0x00, 0x76, 0x61, 0x6c, 0x75,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06,
  0x00, 0x06, 0x00, 0x00, 0x61, 0x6c, 0x6d, 0x61,
  0x66, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_single_message_and_indirect_v20[129] = {
  0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x94, 0xb7,
  0xf1, 0x00, 0x02, 0xc0, 0x08, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x20, 0x58, 0x00, 0x0a,
  0x00, 0x01, 0x00, 0x08, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x5e,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x28, 0x01, 0x01, 0x04, 0x00, 0x03, 0x00, 0x02,
  0x00, 0x02, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00,
  0x00, 0x02, 0x00, 0x06, 0x00, 0x06, 0x00, 0x00,
  0x61, 0x6c, 0x6d, 0x61, 0x66, 0x61, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00,
};

const guint8 logmessage_serialized_single_message_and_sdata_v20[145] = {
  0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x94, 0xb7,
  0xf1, 0x00, 0x02, 0xc0, 0x08, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x08, 0x00, 0x00, 0x00, 0x20, 0x58, 0x00, 0x0e,
  0x00, 0x01, 0x00, 0x08, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x61,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x38, 0x00, 0x10, 0x08, 0x00, 0x06, 0x00, 0x2e,
  0x53, 0x44, 0x41, 0x54, 0x41, 0x2e, 0x61, 0x6c,
  0x6d, 0x61, 0x2e, 0x62, 0x65, 0x6c, 0x61, 0x00,
  0x63, 0x69, 0x74, 0x72, 0x6f, 0x6d, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x06, 0x00, 0x06, 0x00, 0x00,
  0x61, 0x6c, 0x6d, 0x61, 0x66, 0x61, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00,
};

const guint8 logmessage_serialized_big_endian_single_message_v23[109] = {
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x83, 0xb2,
  0x88, 0x00, 0x03, 0xf6, 0xdf, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x4e, 0x56, 0x54, 0x32, 0x01, 0x00, 0x20,
  0x00, 0x06, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x06, 0x00, 0x06, 0x00, 0x61, 0x6c, 0x6d, 0x61,
  0x66, 0x61, 0x00, 0x00, 0x00, 0x00, 0x04, 0x20,
  0x08, 0x00, 0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_big_endian_single_message_and_dynamic_v23[133] = {
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x83, 0xb2,
  0x88, 0x00, 0x03, 0xf9, 0xe0, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x4e, 0x56, 0x54, 0x32, 0x01, 0x00, 0x20,
  0x00, 0x0b, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7b, 0x00,
  0x0b, 0x00, 0x04, 0x00, 0x05, 0x00, 0x05, 0x61,
  0x6c, 0x6d, 0x61, 0x00, 0x76, 0x61, 0x6c, 0x75,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x06, 0x00, 0x06, 0x00, 0x61, 0x6c, 0x6d, 0x61,
  0x66, 0x61, 0x00, 0x00, 0x00, 0x00, 0x04, 0x20,
  0x08, 0x00, 0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_big_endian_single_message_and_sdata_v23[147] = {
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x83, 0xb2,
  0x88, 0x00, 0x03, 0xfe, 0x47, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x08, 0x01, 0x7c, 0x4e, 0x56, 0x54, 0x32, 0x01,
  0x00, 0x20, 0x00, 0x0e, 0x00, 0x01, 0x08, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x7c, 0x00, 0x0e, 0x00, 0x10, 0x00, 0x08, 0x00,
  0x06, 0x2e, 0x53, 0x44, 0x41, 0x54, 0x41, 0x2e,
  0x61, 0x6c, 0x6d, 0x61, 0x2e, 0x62, 0x65, 0x6c,
  0x61, 0x00, 0x63, 0x69, 0x74, 0x72, 0x6f, 0x6d,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00,
  0x06, 0x00, 0x61, 0x6c, 0x6d, 0x61, 0x66, 0x61,
  0x00, 0x00, 0x00, 0x00, 0x04, 0x20, 0x08, 0x00,
  0x00, 0x00, 0x00,
};

const guint8 logmessage_serialized_big_endian_single_message_and_indirect_v23[129] = {
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
  0xff, 0x00, 0x00, 0x00, 0x00, 0x52, 0x83, 0xb2,
  0x88, 0x00, 0x03, 0xfc, 0x33, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x4e, 0x56, 0x54, 0x32, 0x01, 0x00, 0x20,
  0x00, 0x0a, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00,
  0x0a, 0x80, 0x01, 0x00, 0x04, 0x00, 0x03, 0x00,
  0x02, 0x00, 0x02, 0x00, 0x30, 0x00, 0x00, 0x00,
  0x00, 0x40, 0x00, 0x00, 0x06, 0x00, 0x06, 0x00,
  0x61, 0x6c, 0x6d, 0x61, 0x66, 0x61, 0x00, 0x00,
  0x00, 0x00, 0x04, 0x20, 0x08, 0x00, 0x00, 0x00,
  0x00,
};

const guint8 nv_table_serialized_v23_empty[] = {
  0x32, 0x54, 0x56, 0x4e, // "2TVN"
  0x00, // Flags
  0x00, 0x0c, // Size
  0x00, 0x00, // Used
  0x00, 0x00, // Dynamic Entries
  0x00, //Static entries
};

const guint8 nv_table_serialized_v23_single_static_item[] = {
  0x32, 0x54, 0x56, 0x4e, // "2TVN"
  0x00, // Flags
  0x00, 0x09, // Size 36 byte = 9 unit
  0x00, 0x05, // Used 20 byte = 5 unit
  0x00, 0x00, // Dynamic Entries
  0x01, //Static entries
  0x00, 0x05, // Static entry#1 (ofs) negative ofs in units
  // NVEntry #1
    0x00, // flags
    0x00, // Name Length
    0x05, 0x00, // Alloc Length
    0x0B, 0x00, // Value Length
    0x00, // Padding before value
    0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49, 0x44, //Value
    0x00, 0x00 ,0x00, // Padding
};

const guint8 nv_table_serialized_v23_two_static_item[] = {
  0x32, 0x54, 0x56, 0x4e, // "2TVN"
  0x00, // Flags
  0x00, 0x0f, // Size 60 byte = 15 unit
  0x00, 0x0a, // Used 40 byte = 10 unit
  0x00, 0x00, // Dynamic Entries
  0x02, //Static entries
  0x00, 0x0a, // Static entry#1 (ofs) negative ofs in units
  0x00, 0x05, // Static entry#2 (ofs) negative ofs in units
  // NVEntry #1
    0x00, // flags
    0x00, // Name Length
    0x05, 0x00, // Alloc Length
    0x0A, 0x00, // Value Length
    0x00, // Padding before value
    0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49, 0x44, //Value
    0x00, 0x00 ,0x00, // Padding
    0x00, // flags
    0x00, // Name Length
    0x05, 0x00, // Alloc Length
    0x0A, 0x00, // Value Length
    0x00, // Padding before value
    0x50, 0x6F, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49, 0x44, //Value
    0x00, 0x00 ,0x00, // Padding
};

const guint8 nv_table_serialized_v23_dynamic_item[] = {
  0x32, 0x54, 0x56, 0x4e, // "2TVN"
  0x00, // Flags
  0x00, 0x0a, // Size 60 byte = 15 unit
  0x00, 0x06, // Used 40 byte = 10 unit
  0x00, 0x01, // Dynamic Entries
  0x00, //Static entries
  0x00, 0x0a, 0x00, 0x06, // Dynamic entry#1 (ofs) negative ofs in units
  // NVEntry #1 24 byte = 6 unit
    0x00, // flags
    0x04, // Name Length
    0x06, 0x00, // Alloc Length
    0x0A, 0x00, // Value Length
    0x61, 0x6C, 0x6D, 0x61, 0x00,
    0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49, 0x44, //Value
    0x00, 0x00, 0x00 // Padding
};

#define TEST_ASSERT(x, format, value, expected)		\
  do 				\
    { 				\
        if (!(x))		\
          {			\
            fprintf(stderr, "Testcase failed; msg='%s', cond='%s', value=" format ", expected=" format "\n", testcase_name, #x, value, expected); \
            exit(1);		\
          }			\
    }				\
  while (0)

unsigned long
absolute_value(signed long diff)
{
  if (diff < 0)
    return -diff;
  else
    return diff;
}

void
test_msg_read(const gchar *testcase_name,
              const guint8 *serialized_msg, gsize serialized_msg_len,
              gint expected_pri,
              unsigned long expected_stamp_sec,
              unsigned long expected_stamp_usec,
              unsigned long expected_stamp_ofs,
              const gchar *expected_host,
              const gchar *expected_program,
              const gchar *expected_msg,
              const gchar *expected_sd_str,
              const gchar *expected_pid,
              const gchar *expected_msgid,
              const gchar *expected_sd_pairs[][2])

{
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  LogMessage *logmsg;
  time_t now;
  GString *sd_str = g_string_sized_new(0);

  g_string_assign_len(serialized, (gchar *) serialized_msg, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  logmsg = log_msg_new_empty();
  if (!log_msg_deserialize(logmsg, sa))
    {
      fprintf(stderr, "Error deserializing stored message\n");
      exit(1);
    }
  serialize_archive_free(sa);
  g_string_free(serialized, TRUE);

  TEST_ASSERT(logmsg->pri == expected_pri, "%d", logmsg->pri, expected_pri);
  if (expected_stamp_sec)
    {
      if (expected_stamp_sec != 1)
        {
          TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].tv_sec == expected_stamp_sec,
                      "%d",
                      (int) logmsg->timestamps[LM_TS_STAMP].tv_sec,
                      (int) expected_stamp_sec);
        }
      TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].tv_usec == expected_stamp_usec,
                  "%d",
                  (int) logmsg->timestamps[LM_TS_STAMP].tv_usec,
                  (int) expected_stamp_usec);
      TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].zone_offset == expected_stamp_ofs,
                  "%d",
                  (int) logmsg->timestamps[LM_TS_STAMP].zone_offset,
                  (int) expected_stamp_ofs);
    }
  else
    {
      time(&now);
      TEST_ASSERT(absolute_value(logmsg->timestamps[LM_TS_STAMP].tv_sec - now) < 1,
                  "%d",
                  0,
                  0);
    }
  TEST_ASSERT(!expected_host || strcmp(log_msg_get_value(logmsg, LM_V_HOST, NULL), expected_host) == 0,
              "%s",
              log_msg_get_value(logmsg, LM_V_HOST, NULL),
              expected_host);
  TEST_ASSERT(!expected_program || strcmp(log_msg_get_value(logmsg, LM_V_PROGRAM, NULL), expected_program) == 0,
              "%s",
              log_msg_get_value(logmsg, LM_V_PROGRAM, NULL),
              expected_program);
  TEST_ASSERT(!expected_msg || strcmp(log_msg_get_value(logmsg, LM_V_MESSAGE, NULL), expected_msg) == 0,
              "%s",
              log_msg_get_value(logmsg, LM_V_MESSAGE, NULL),
              expected_msg);
  TEST_ASSERT(!expected_pid || strcmp(log_msg_get_value(logmsg, LM_V_PID, NULL), expected_pid) == 0,
              "%s",
              log_msg_get_value(logmsg, LM_V_PID, NULL),
              expected_pid);
  TEST_ASSERT(!expected_msgid || strcmp(log_msg_get_value(logmsg, LM_V_MSGID, NULL), expected_msgid) == 0,
              "%s",
              log_msg_get_value(logmsg, LM_V_MSGID, NULL),
              expected_msgid);

  /* SD elements */
  log_msg_format_sdata(logmsg, sd_str, 0);
  TEST_ASSERT(!expected_sd_str || strcmp(sd_str->str, expected_sd_str) == 0,
              "%s",
              sd_str->str,
              expected_sd_str);
  if (expected_sd_pairs)
    {
      int i = 0;

      while(expected_sd_pairs[i][0] != NULL)
        {
          const gchar *name = expected_sd_pairs[i][0];
          const gchar *expected_value = expected_sd_pairs[i][1];
          NVHandle handle = log_msg_get_value_handle(name);
          gssize length;
          const gchar *actual_value = log_msg_get_value(logmsg, handle, &length);

          TEST_ASSERT(strncmp(actual_value, expected_value, length) == 0,
                      "%s", actual_value, expected_value);

          i++;
        }
    }

  log_msg_unref(logmsg);
  g_string_free(sd_str, TRUE);
}

void
test_nv_table_upgrade_from_v23_to_v24()
{
  const char *testcase_name = "test_nv_table_upgrade_from_v23_to_v24";
  int serialized_msg_len = sizeof(nv_table_serialized_v23_empty);
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  NVTable *nvt;

  g_string_assign_len(serialized, (gchar *) nv_table_serialized_v23_empty, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  nvt = nv_table_deserialize(sa, 23);
  TEST_ASSERT(nvt != NULL, "%s", "alma", "korte");
}

void
test_nv_table_upgrade_from_v23_to_v24_single_static_entry()
{
  const char *testcase_name = "test_nv_table_upgrade_from_v23_to_v24_single_static_entry";
  int serialized_msg_len = sizeof(nv_table_serialized_v23_single_static_item);
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  NVTable *nvt;
  const char *result;

  g_string_assign_len(serialized, (gchar *) nv_table_serialized_v23_single_static_item, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  nvt = nv_table_deserialize(sa, 23);
  result = nv_table_get_value(nvt, LM_V_HOST, NULL);

  TEST_ASSERT(nvt != NULL, "%s", "alma", "korte");
  TEST_ASSERT(!strcmp(result, "Process ID"), "%s", result, "Process ID");
}

void
test_nv_table_upgrade_from_v23_to_v24_two_static_entries()
{
  const char *testcase_name = "test_nv_table_upgrade_from_v23_to_v24_two_static_entries";
  int serialized_msg_len = sizeof(nv_table_serialized_v23_two_static_item);
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  NVTable *nvt;
  const char *result, *result2;

  g_string_assign_len(serialized, (gchar *) nv_table_serialized_v23_two_static_item, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  nvt = nv_table_deserialize(sa, 23);

  result = nv_table_get_value(nvt, LM_V_HOST, NULL);
  result2 = nv_table_get_value(nvt, LM_V_HOST_FROM, NULL);

  TEST_ASSERT(nvt != NULL, "%s", "alma", "korte");
  TEST_ASSERT(!strncmp(result, "Process ID",10), "%s", result, "Process ID");
  TEST_ASSERT(!strncmp(result2, "Poocess ID",10), "%s", result2, "Poocess ID");
}

void
test_nv_table_upgrade_from_v23_to_v24_dynamic_item()
{
  const char* testcase_name = "test_nv_table_upgrade_from_v23_to_v24_dynamic_item";
  int serialized_msg_len = sizeof(nv_table_serialized_v23_dynamic_item);
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  NVTable *nvt;
  NVHandle handle;
  const char *result;

  g_string_assign_len(serialized, (gchar *) nv_table_serialized_v23_dynamic_item, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  nvt = nv_table_deserialize(sa, 23);
  nv_table_update_ids(nvt, logmsg_registry, NULL, 0);

  handle = log_msg_get_value_handle("alma");
  result = nv_table_get_value(nvt, handle, NULL);

  TEST_ASSERT(nvt != NULL, "%s", "alma", "korte");
  TEST_ASSERT(!strncmp(result, "Process ID",10), "%s", result, "Process ID");
}

int
main()
{
  app_startup();

  test_nv_table_upgrade_from_v23_to_v24();
  test_nv_table_upgrade_from_v23_to_v24_single_static_entry();
  test_nv_table_upgrade_from_v23_to_v24_two_static_entries();
  test_nv_table_upgrade_from_v23_to_v24_dynamic_item();

  test_msg_read("upgrade from 5.0 to 5.1, big endian, single message", logmessage_serialized_big_endian_single_message_v23,
           sizeof(logmessage_serialized_big_endian_single_message_v23),
           65535,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, NULL);

  const gchar *dynvalue_pairs_v23[][2] = { { "alma", "value" }, { NULL, NULL}, };

  test_msg_read("upgrade from 5.0 to 5.1, big endian, single message + dynamic value", logmessage_serialized_big_endian_single_message_and_dynamic_v23,
           sizeof(logmessage_serialized_big_endian_single_message_and_dynamic_v23),
           65535,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, dynvalue_pairs_v23);

  const gchar *match_pairs_v23[][2] = { { "0", "ma" }, { NULL, NULL}, };

  test_msg_read("upgrade from 5.0 to 5.1, big endian, single message + indirect value", logmessage_serialized_big_endian_single_message_and_indirect_v23,
           sizeof(logmessage_serialized_big_endian_single_message_and_indirect_v23),
           65535,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, match_pairs_v23);

  test_msg_read("upgrade from 5.0 to 5.1, big endian, single message + structured data value", logmessage_serialized_big_endian_single_message_and_sdata_v23,
           sizeof(logmessage_serialized_big_endian_single_message_and_sdata_v23),
           65535,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           "[alma bela=\"citrom\"]", NULL, NULL, NULL);

  test_msg_read("upgrade from pre-3.2 to 5.1, single message", logmessage_serialized_single_message_v20,
           sizeof(logmessage_serialized_single_message_v20),
           1,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, NULL);

  const gchar *dynvalue_pairs_v20[][2] = { { "alma", "value" }, { NULL, NULL}, };

  test_msg_read("upgrade from pre-3.2 to 5.1, single message + dynamic value", logmessage_serialized_single_message_and_dynamic_v20,
           sizeof(logmessage_serialized_single_message_and_dynamic_v20),
           1,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, dynvalue_pairs_v20);

  const gchar *match_pairs_v20[][2] = { { "0", "ma" }, { NULL, NULL}, };

  test_msg_read("upgrade from pre-3.2 to 5.1, single message + indirect value", logmessage_serialized_single_message_and_indirect_v20,
           sizeof(logmessage_serialized_single_message_and_indirect_v20),
           1,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           NULL, NULL, NULL, match_pairs_v20);

  test_msg_read("upgrade from pre-3.2 to 5.1, single message + structured data value", logmessage_serialized_single_message_and_sdata_v20,
           sizeof(logmessage_serialized_single_message_and_sdata_v20),
           1,
           -1, 0, -1,
           NULL,
           NULL,
           "almafa",
           "[alma bela=\"citrom\"]", NULL, NULL, NULL);


  test_msg_read("upgrade from 2.1 (version 1)", msg_serialized_21, sizeof(msg_serialized_21),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           NULL, NULL, NULL, NULL);
  test_msg_read("upgrade from 3.0.1 (version 10)", msg_serialized_version10, sizeof(msg_serialized_version10),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           NULL, NULL, NULL, NULL);
  test_msg_read("upgrade from 3.1 to 3.1 (version 11 to 12)", msg_serialized_version11, sizeof(msg_serialized_version11),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           "[Element ParamName=\"ParamValue\"]", "Process ID", "Message ID", NULL);
  test_msg_read("upgrade from 5.0 to 5.1 (version 23 to 24)", msg_serialized_version23, sizeof(msg_serialized_version23),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           "[Element ParamName=\"ParamValue\"]", "Process ID", "Message ID", NULL);

  app_shutdown();
  return 0;
}
